<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  

  <!--Author-->
  
  <meta name="author" content="ZiHan.Xia">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="iOS简单多级下拉菜单开发"/>
  
  <!--Open Graph Description-->
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="ZiHan Blog"/>
  <!--Type page-->
  
      <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>iOS简单多级下拉菜单开发 - ZiHan Blog</title>


  <link rel="shortcut icon" href="http://op6guxky2.bkt.clouddn.com/logo@2x.png">

  <!-- Custom CSS/Sass -->
  <link rel="stylesheet" href="/css/style.css">

  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

</head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="http://op6guxky2.bkt.clouddn.com/logo@2x.png" alt="ZiHan Blog" height="60">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  home
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  archive
                
              </a>
            </li>
          
            <li>
              <a href="/about">
                
                  about
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            iOS简单多级下拉菜单开发
            
          </h1>
          <p class="posted-on">
          2017-08-11
          </p>
          <div class="tags-links">
            
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content">
          <h2 id="iOS多级下拉菜单开发"><a href="#iOS多级下拉菜单开发" class="headerlink" title="iOS多级下拉菜单开发"></a><div style="text-align:center">iOS多级下拉菜单开发<div></div></div></h2><p>为接下来我们要做什么有个底，先来看看完成后的效果图。总的来说我们要实现这样一个下拉控件，点击城市按钮，就会弹出城市选择下拉列表，点击第一列或者第二列就会根据点击的行刷新后面的列表，比如点击了省份这一列会更新相应的城市列表和区县列表，大概可以用<font color="#FF8C00">级联更新</font>这个词来描述吧！在点击最后一列后列表会消失，点击灰色区域城市列表也会消失，在列表展示的情况下，点击城市按钮，城市列表也会消失。停止哔哔🤣😂，撸起袖子开始干！</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/%E5%AE%8C%E6%88%90%E6%95%88%E6%9E%9C%E5%9B%BE.png?imageView2/2/w/375" alt=""></p>
<p>我们这次的重点是多级下拉列表的开发，因此我们从一个初始项目开始，直接进入下拉列表的开发的开发环节🤡🤡。从这里下载我们的<a href="https://github.com/EgeTart/MlutiLevelMenuDemo/tree/6cdb271ca7b7b515ab7ade87411702f4e56d48cd">初始项目</a>，下图是初始项目运行后的结果。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/%E5%88%9D%E5%A7%8B%E9%A1%B9%E7%9B%AE%E6%95%88%E6%9E%9C.png?imageView2/2/w/375" alt=""></p>
<p>做一个小小的说明：</p>
<blockquote>
<ul>
<li>这次我们项目中使用<font color="#FF8C00">SnapKit</font>以纯代码的方式进行界面布局，不熟悉的朋友不同担心，我们的Demo项目界面比较简单，布局代码也是简洁明了的。</li>
<li>另外城市列表数据格式为json，我们通过<font color="#FF8C00">Unbox</font>第三方库，将json数据转成项目中可以使用的Model</li>
<li>这两个库已经通过pod安装，包含在初始项目中，初始列表还包括城市列表数据</li>
</ul>
</blockquote>
<p>从此刻开始我们的多级下拉控件叫做<font color="#FF8C00">MultiLevelMenu</font></p>
<p>我们使用多个UITableView来实现多个列表，从完成效果图来看，这里有3个UITableView对象，可是为了把这个MultiLevelMenu控件做成一个通用控件，我们需要让外界提供给数据给MultiLevelMenu，然后进行展示。类似UITableView的数据源方法，我们也会创建<font color="#FF8C00">DataSource 协议</font>，让外界通过这个协议为MultiLevelMenu提供数据。</p>
<p><strong>好开心，好开心，终于可以敲代码了😈😈😈！</strong></p>
<p>打开项目文件导航栏，选中<font color="#FF8C00">View</font>这个Group，（command + n）创建一个UIView的子类<font color="#FF8C00">MultiLevelMenu</font>，这个就是我们的多级下拉列表啦！刚刚的操作可以看一看下面的步骤截图。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/%E6%AD%A5%E9%AA%A41.png" alt=""></p>
<p>打开<font color="#FF8C00">MultiLevelMenu.swift</font>文件，添加初始化方法，在这里我们将背景色设置为黑色，透明度为0.5。这样做的目的是，在展示MultiLevelMenu控件时，会有一层灰黑色蒙版，具体可以参考完成后的效果图。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiLevelMenu</span>: <span class="title">UIView</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</div><div class="line">        <span class="keyword">self</span>.backgroundColor = <span class="type">UIColor</span>(white: <span class="number">0</span>, alpha: <span class="number">0.5</span>)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</div><div class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在类MultiLevelMenu定义的上方，添加一个数据源协议<font color="#FF8C00">MultiLevelMenuDataSource</font>，声明如下</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@objc</span> <span class="class"><span class="keyword">protocol</span> <span class="title">MultiLevelMenuDataSource</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</div><div class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">numberOfLevel</span><span class="params">(of multiLevelMenu: MultiLevelMenu)</span></span> -&gt; <span class="type">Int</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在MultiLevelMenuDataSource声明中只有一个方法，外界通过这个数据源方法，告诉MultiLevelMenu要显示多少个级别的数据，比如返回3，那么就会有3个列表。MultiLevelMenu通过这个数据源方法，配置列表和数据。</p>
<p>数据源协议声明好了，我们在MultiLevelMenu类中添加一个<font color="#FF8C00">dataSource</font>属性，代表数据源。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">weak</span> <span class="keyword">var</span> dataSource: <span class="type">MultiLevelMenuDataSource</span>?</div></pre></td></tr></table></figure>
<p>暂时把数据源放一放，为了在table view上展示城市信息，定义一个UITableViewCell的子类<font color="#FF8C00">LevelItemCell</font>，在MultiLevelMenuDataSource的声明下面定义这个类。这个cell非常简单，只包含了一个label控件，设置了label的文字居中。同时为LevelItemCell增加了紫色选中效果。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">fileprivate</span> <span class="class"><span class="keyword">class</span> <span class="title">LevelItemCell</span>: <span class="title">UITableViewCell</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> levelNamelabel: <span class="type">UILabel</span> = &#123;</div><div class="line">        <span class="keyword">let</span> label = <span class="type">UILabel</span>()</div><div class="line">        label.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">14</span>)</div><div class="line">        label.textAlignment = .center</div><div class="line">        <span class="keyword">return</span> label</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(style: <span class="type">UITableViewCellStyle</span>, reuseIdentifier: <span class="type">String</span>?) &#123;</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(style: style, reuseIdentifier: reuseIdentifier)</div><div class="line">        <span class="keyword">self</span>.backgroundColor = <span class="type">UIColor</span>.clear</div><div class="line">        </div><div class="line">        <span class="comment">// 布局label</span></div><div class="line">        <span class="keyword">self</span>.contentView.addSubview(levelNamelabel)</div><div class="line">        levelNamelabel.snp.makeConstraints &#123; (make) <span class="keyword">in</span></div><div class="line">            make.edges.equalToSuperview().inset(<span class="type">UIEdgeInsetsMake</span>(<span class="number">8</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">12</span>))</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 添加紫色选中效果</span></div><div class="line">        <span class="keyword">let</span> view = <span class="type">UIView</span>()</div><div class="line">        view.backgroundColor = <span class="type">UIColor</span>(red: <span class="number">198</span> / <span class="number">255.0</span>, green: <span class="number">165</span> / <span class="number">255.0</span>, blue: <span class="number">223</span> / <span class="number">255.0</span>, alpha: <span class="number">0.3</span>)</div><div class="line">        <span class="keyword">self</span>.selectedBackgroundView = view</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</div><div class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好了，有了LevelItemCell，接着就要在table view中展示它们了。回到MultiLevelMenu类中，在<font color="#FF8C00">init(frame: CGRect)</font>初始化方法的上方，添加3个私有变量，分别代表cell的重用标识符，有多少级列表需要展示，以及存储展示的列表。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">fileprivate</span> <span class="keyword">let</span> <span class="type">LevelItemCellReuseIdentifier</span> = <span class="string">"LevelItemCellReuseIdentifier"</span></div><div class="line"><span class="keyword">fileprivate</span> <span class="built_in">lazy</span> <span class="keyword">var</span> numberOfLvel = <span class="number">0</span></div><div class="line"><span class="keyword">fileprivate</span> <span class="built_in">lazy</span> <span class="keyword">var</span> menuTableViews = [<span class="type">UITableView</span>]()</div></pre></td></tr></table></figure>
<p>再添加一个容器view，我们的城市列表都会放在这个容器view中，方便管理和实现一些动画效果。在menuTableViews变量的下方，创建这个view</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> containerView: <span class="type">UIView</span> = &#123;</div><div class="line">    <span class="keyword">let</span> view = <span class="type">UIView</span>()</div><div class="line">    <span class="keyword">return</span> view</div><div class="line">&#125;()</div></pre></td></tr></table></figure>
<p>接下来我们在MultiLevelMenu类中添加两个私有方法，用来创建展示城市数据的table view，以及对table view进行布局。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建table view</span></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">createMenuTableView</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> level <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="keyword">self</span>.numberOfLvel &#123;</div><div class="line">        <span class="keyword">let</span> tableView = <span class="type">UITableView</span>()</div><div class="line">        tableView.register(<span class="type">LevelItemCell</span>.<span class="keyword">self</span>, forCellReuseIdentifier: <span class="type">LevelItemCellReuseIdentifier</span>)</div><div class="line">        tableView.tag = <span class="number">100</span> + level</div><div class="line">        tableView.rowHeight = <span class="type">UITableViewAutomaticDimension</span></div><div class="line">        tableView.estimatedRowHeight = <span class="number">40</span></div><div class="line">        tableView.tableFooterView = <span class="type">UIView</span>()</div><div class="line">        tableView.showsVerticalScrollIndicator = <span class="literal">false</span></div><div class="line">        tableView.separatorColor = <span class="type">UIColor</span>(white: <span class="number">0.9</span>, alpha: <span class="number">1.0</span>)</div><div class="line">        tableView.separatorInset = <span class="type">UIEdgeInsetsMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</div><div class="line">        tableView.dataSource = <span class="keyword">self</span></div><div class="line">        tableView.delegate = <span class="keyword">self</span></div><div class="line">        </div><div class="line">        menuTableViews.append(tableView)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    configureLayout()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 布局table view</span></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">configureLayout</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">self</span>.addSubview(containerView)</div><div class="line">    <span class="keyword">for</span> (index, tableView) <span class="keyword">in</span> menuTableViews.enumerated() &#123;</div><div class="line">        containerView.addSubview(tableView)</div><div class="line">        </div><div class="line">        tableView.snp.makeConstraints(&#123; (make) <span class="keyword">in</span></div><div class="line">            make.top.bottom.equalToSuperview()</div><div class="line">            make.width.equalToSuperview().multipliedBy(<span class="number">1.0</span> / <span class="type">Double</span>(<span class="keyword">self</span>.numberOfLvel))</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> index == <span class="number">0</span> &#123;</div><div class="line">                make.leading.equalToSuperview()</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                make.leading.equalTo(<span class="keyword">self</span>.menuTableViews[index - <span class="number">1</span>].snp.trailing)</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    containerView.snp.makeConstraints &#123; (make) <span class="keyword">in</span></div><div class="line">        make.leading.top.trailing.equalToSuperview()</div><div class="line">        make.height.equalTo(<span class="number">240</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建table view这个方法很好懂，在这里对table view做了一些常规的配置，由于我们还没有实现UITableView的数据源方法和delegate方法，这里编译器会有错误提示，这个不要紧，我们后面加上去。</p>
<p>在布局table view的方法中，为每个table view添加约束，table view的top和bottom和containerView一致；width为containerView的<font color="#FF8C00">1.0 / numberOfLvel</font>，也就是说如果有3个级别，那么每个列表的宽度为containerView的<font color="#FF8C00">1/3</font>；table view的左边的约束设置与containerView的左边相等或者与前一级列表的右边相等。最后设置containerView的左边，上边，右边约束与MultiLevelMenu对象本身相等，height约束为240，这个可以根据需要改变。希望我有解释清楚这个方法😂😂。</p>
<p>现在我们使用<font color="#FF8C00">extension</font>的方式为MultiLevelMenu添加UITableView的数据源方法和delegate方法。在MultiLevelMenu类最后的花括号下面添加以下代码段。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MultiLevelMenu</span>: <span class="title">UITableViewDataSource</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">5</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</div><div class="line">        <span class="keyword">let</span> level = tableView.tag - <span class="number">100</span></div><div class="line">        <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="type">LevelItemCellReuseIdentifier</span>, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">LevelItemCell</span></div><div class="line">        cell.levelNamelabel.text = <span class="string">"level <span class="subst">\(level)</span>-<span class="subst">\(indexPath.row)</span>"</span></div><div class="line">        <span class="keyword">return</span> cell</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MultiLevelMenu</span>: <span class="title">UITableViewDelegate</span> </span>&#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们添加这两段代码纯粹是为了验证能否将MultiLevelMenu正确的展示出来。</p>
<p>我们为MultiLevelMenu的dataSource属性添加一个属性观察器，当dataSource被设置之后，我们就调用数据源方法<font color="#FF8C00">numberOfLevel(of multiLevelMenu: MultiLevelMenu)</font>，获得需要展示多少个级别的信息并创建table view。代码如下</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">weak</span> <span class="keyword">var</span> dataSource: <span class="type">MultiLevelMenuDataSource</span>? &#123;</div><div class="line">    <span class="keyword">didSet</span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> dataSource = dataSource <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        numberOfLvel = dataSource.numberOfLevel(of: <span class="keyword">self</span>)</div><div class="line">        createMenuTableView()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了有个参考，贴出到目前为止整个MultiLevelMenu.swift文件的代码。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"></div><div class="line"><span class="meta">@objc</span> <span class="class"><span class="keyword">protocol</span> <span class="title">MultiLevelMenuDataSource</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</div><div class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">numberOfLevel</span><span class="params">(of multiLevelMenu: MultiLevelMenu)</span></span> -&gt; <span class="type">Int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">fileprivate</span> <span class="class"><span class="keyword">class</span> <span class="title">LevelItemCell</span>: <span class="title">UITableViewCell</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> levelNamelabel: <span class="type">UILabel</span> = &#123;</div><div class="line">        <span class="keyword">let</span> label = <span class="type">UILabel</span>()</div><div class="line">        label.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">14</span>)</div><div class="line">        label.textAlignment = .center</div><div class="line">        <span class="keyword">return</span> label</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(style: <span class="type">UITableViewCellStyle</span>, reuseIdentifier: <span class="type">String</span>?) &#123;</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(style: style, reuseIdentifier: reuseIdentifier)</div><div class="line">        <span class="keyword">self</span>.backgroundColor = <span class="type">UIColor</span>.clear</div><div class="line">        </div><div class="line">        <span class="comment">// 布局label</span></div><div class="line">        <span class="keyword">self</span>.contentView.addSubview(levelNamelabel)</div><div class="line">        levelNamelabel.snp.makeConstraints &#123; (make) <span class="keyword">in</span></div><div class="line">            make.edges.equalToSuperview().inset(<span class="type">UIEdgeInsetsMake</span>(<span class="number">8</span>, <span class="number">12</span>, <span class="number">8</span>, <span class="number">12</span>))</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 添加紫色选中效果</span></div><div class="line">        <span class="keyword">let</span> view = <span class="type">UIView</span>()</div><div class="line">        view.backgroundColor = <span class="type">UIColor</span>(red: <span class="number">198</span> / <span class="number">255.0</span>, green: <span class="number">165</span> / <span class="number">255.0</span>, blue: <span class="number">223</span> / <span class="number">255.0</span>, alpha: <span class="number">0.3</span>)</div><div class="line">        <span class="keyword">self</span>.selectedBackgroundView = view</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</div><div class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiLevelMenu</span>: <span class="title">UIView</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//MARK: - 公开变量</span></div><div class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> dataSource: <span class="type">MultiLevelMenuDataSource</span>? &#123;</div><div class="line">        <span class="keyword">didSet</span> &#123;</div><div class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> dataSource = dataSource <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span></div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            numberOfLvel = dataSource.numberOfLevel(of: <span class="keyword">self</span>)</div><div class="line">            createMenuTableView()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//MARK: - 私有变量</span></div><div class="line">    <span class="keyword">fileprivate</span> <span class="keyword">let</span> <span class="type">LevelItemCellReuseIdentifier</span> = <span class="string">"LevelItemCellReuseIdentifier"</span></div><div class="line">    <span class="keyword">fileprivate</span> <span class="built_in">lazy</span> <span class="keyword">var</span> numberOfLvel = <span class="number">0</span></div><div class="line">    <span class="keyword">fileprivate</span> <span class="built_in">lazy</span> <span class="keyword">var</span> menuTableViews = [<span class="type">UITableView</span>]()</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> containerView: <span class="type">UIView</span> = &#123;</div><div class="line">        <span class="keyword">let</span> view = <span class="type">UIView</span>()</div><div class="line">        <span class="keyword">return</span> view</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</div><div class="line">        <span class="keyword">self</span>.backgroundColor = <span class="type">UIColor</span>(white: <span class="number">0</span>, alpha: <span class="number">0.5</span>)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</div><div class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 创建table view</span></div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">createMenuTableView</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> level <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="keyword">self</span>.numberOfLvel &#123;</div><div class="line">            <span class="keyword">let</span> tableView = <span class="type">UITableView</span>()</div><div class="line">            tableView.register(<span class="type">LevelItemCell</span>.<span class="keyword">self</span>, forCellReuseIdentifier: <span class="type">LevelItemCellReuseIdentifier</span>)</div><div class="line">            tableView.tag = <span class="number">100</span> + level</div><div class="line">            tableView.rowHeight = <span class="type">UITableViewAutomaticDimension</span></div><div class="line">            tableView.estimatedRowHeight = <span class="number">40</span></div><div class="line">            tableView.tableFooterView = <span class="type">UIView</span>()</div><div class="line">            tableView.showsVerticalScrollIndicator = <span class="literal">false</span></div><div class="line">            tableView.separatorColor = <span class="type">UIColor</span>(white: <span class="number">0.9</span>, alpha: <span class="number">1.0</span>)</div><div class="line">            tableView.separatorInset = <span class="type">UIEdgeInsetsMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</div><div class="line">            tableView.dataSource = <span class="keyword">self</span></div><div class="line">            tableView.delegate = <span class="keyword">self</span></div><div class="line">            </div><div class="line">            menuTableViews.append(tableView)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        configureLayout()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 布局table view</span></div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">configureLayout</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">self</span>.addSubview(containerView)</div><div class="line">        <span class="keyword">for</span> (index, tableView) <span class="keyword">in</span> menuTableViews.enumerated() &#123;</div><div class="line">            containerView.addSubview(tableView)</div><div class="line">            </div><div class="line">            tableView.snp.makeConstraints(&#123; (make) <span class="keyword">in</span></div><div class="line">                make.top.bottom.equalToSuperview()</div><div class="line">                make.width.equalToSuperview().multipliedBy(<span class="number">1.0</span> / <span class="type">Double</span>(<span class="keyword">self</span>.numberOfLvel))</div><div class="line">                </div><div class="line">                <span class="keyword">if</span> index == <span class="number">0</span> &#123;</div><div class="line">                    make.leading.equalToSuperview()</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    make.leading.equalTo(<span class="keyword">self</span>.menuTableViews[index - <span class="number">1</span>].snp.trailing)</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        containerView.snp.makeConstraints &#123; (make) <span class="keyword">in</span></div><div class="line">            make.leading.top.trailing.equalToSuperview()</div><div class="line">            make.height.equalTo(<span class="number">240</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MultiLevelMenu</span>: <span class="title">UITableViewDataSource</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">5</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</div><div class="line">        <span class="keyword">let</span> level = tableView.tag - <span class="number">100</span></div><div class="line">        <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="type">LevelItemCellReuseIdentifier</span>, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">LevelItemCell</span></div><div class="line">        cell.levelNamelabel.text = <span class="string">"level <span class="subst">\(level)</span>-<span class="subst">\(indexPath.row)</span>"</span></div><div class="line">        <span class="keyword">return</span> cell</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MultiLevelMenu</span>: <span class="title">UITableViewDelegate</span> </span>&#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们切换到<font color="#FF8C00">HomeViewController.swift</font>文件，对MultiLevelMenu做个简单的展示验证。在<font color="#FF8C00">createSeparateLine()</font>方法下方添加一个<font color="#FF8C00">presentMultiLevelMunu(sender: UIButton)</font>方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@objc</span> <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">presentMultiLevelMunu</span><span class="params">(sender: UIButton)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> multiLevelMenu = <span class="type">MultiLevelMenu</span>(frame: <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">120</span>, width: <span class="keyword">self</span>.view.frame.width, height: <span class="number">500</span>))</div><div class="line">    multiLevelMenu.dataSource = <span class="keyword">self</span></div><div class="line">    <span class="keyword">self</span>.view.addSubview(multiLevelMenu)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>找到cityButton定义的地方，用下面的代码段替换它。点击cityButton将会展示MultiLevelMenu。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> cityButton: <span class="type">UIButton</span> = &#123;</div><div class="line">    <span class="keyword">let</span> button = <span class="keyword">self</span>.createButton(title: <span class="string">"城市"</span>)</div><div class="line">    button.addTarget(<span class="keyword">self</span>, action: #selector(presentMultiLevelMunu(sender:)), <span class="keyword">for</span>: .touchUpInside)</div><div class="line">    <span class="keyword">return</span> button</div><div class="line">&#125;()</div></pre></td></tr></table></figure>
<p>最后实现MultiLevelMenu的数据源方法，告诉MultiLevelMenu需要展示多少级数据。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">HomeViewController</span>: <span class="title">MultiLevelMenuDataSource</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">numberOfLevel</span><span class="params">(of multiLevelMenu: MultiLevelMenu)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">3</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>🐶激动人心的时刻来啦，运行一次看看效果🐹。点击城市按钮之后，可以看到我们已经将MultiLevelMenu展示出来了🐵🐼。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/%E6%95%88%E6%9E%9C1.png?imageView2/2/w/375" alt=""></p>
<p>这里我们是直接把MultiLevelMenu添加到当前controller的view上的，接下来我们换一种方式来展示MultiLevelMenu，在UIWindow上添加MultiLevelMenu。切换到<font color="#FF8C00">MultiLevelMenu.swift</font>文件，添加一个变量用来记录MultiLevelMenu是否已经弹出，再添加两个方法，分别用来弹出和移除MultiLevelMenu。</p>
<blockquote>
<ul>
<li>func presnt(from view: UIView)，从一个view的下方弹出MultiLevelMenu，比如传进来一个button，那么将在这个button的下方显示MultiLevelMenu控件。</li>
<li>func dismiss(animated: Bool) 将MultiLevelMenu控件从UIWindow移除。</li>
<li>var isShowed = false，记录MultiLevelMenu的显示状态</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">presnt</span><span class="params">(from view: UIView)</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> tmpSuperView = view</div><div class="line">    </div><div class="line">    <span class="comment">// 寻找最上级view</span></div><div class="line">    <span class="keyword">while</span> tmpSuperView.superview != <span class="literal">nil</span> &#123;</div><div class="line">        tmpSuperView = tmpSuperView.superview!</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> window = <span class="type">UIApplication</span>.shared.keyWindow</div><div class="line">    window?.addSubview(<span class="keyword">self</span>)</div><div class="line">    </div><div class="line">    <span class="comment">// 进行坐标变化，得到控件左下角相对于最上级view的坐标</span></div><div class="line">    <span class="keyword">var</span> presentPoint: <span class="type">CGPoint</span></div><div class="line">    <span class="keyword">if</span> view.superview == tmpSuperView &#123;</div><div class="line">         presentPoint = <span class="type">CGPoint</span>(x: view.frame.minX, y: view.frame.maxY)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">         presentPoint = tmpSuperView.convert(<span class="type">CGPoint</span>(x: view.frame.minX, y: view.frame.maxY), from: view)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.snp.makeConstraints &#123; (make) <span class="keyword">in</span></div><div class="line">        make.top.equalToSuperview().offset(presentPoint.y)</div><div class="line">        make.leading.trailing.bottom.equalToSuperview()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    isShowed = <span class="literal">true</span></div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">dismiss</span><span class="params">(animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">self</span>.removeFromSuperview()</div><div class="line">    isShowed = <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有必要对func presnt(from view: UIView)解释一下，传进来一个view，我们需要找到它最上级的view(也就是superView)，比如下面的示例图，view2和view3的最上级view都是view1，这里就涉及了一个坐标系问题，view3的坐标是相对于view2，而view2的坐标是相对于view1的。假如我们现在从view3弹出MultiLevelMenu，那么就需要将view3的坐标变换到view1的坐标系中，如果从view2弹出MultiLevelMenu，则不需要进行坐标变换，因为view2的坐标本身就是相对于view1的。</p>
<p>我们在func presnt(from view: UIView)方法中将MultiLevelMenu添加到window上，对MultiLevelMenu添加约束，使MultiLevelMenu显示的位置刚好在传进来view的下方，并占满剩余的空间。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/iPhone%207.png?imageView2/2/w/375" alt=""></p>
<p>切换到<font color="#FF8C00">HomeViewController.swift</font>文件，让我们来试试，刚刚添加的方法。</p>
<p>在viewDidLoad()方法的上方添加一个MultiLevelMenu的示例变量。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> multiLevelMenu: <span class="type">MultiLevelMenu</span> = &#123;</div><div class="line">    <span class="keyword">let</span> multiLevelMenu = <span class="type">MultiLevelMenu</span>()</div><div class="line">    multiLevelMenu.dataSource = <span class="keyword">self</span></div><div class="line">    <span class="keyword">return</span> multiLevelMenu</div><div class="line">&#125;()</div></pre></td></tr></table></figure>
<p>接着我们修改<font color="#FF8C00">presentMultiLevelMunu(sender: UIButton)</font>方法，如果MultiLevelMenu没有弹出，我们就显示它，如果已经显示，我们就移除它。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@objc</span> <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">presentMultiLevelMunu</span><span class="params">(sender: UIButton)</span></span> &#123;</div><div class="line">    multiLevelMenu.isShowed ? multiLevelMenu.dismiss(animated: <span class="literal">true</span>) : multiLevelMenu.presnt(from: sender)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行一遍试试吧😁😁！我们正确的将MultiLevelMenu，显示在cityButton的下方，而且显示，移除都没有问题。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/%E6%95%88%E6%9E%9C3.png?imageView2/2/w/375" alt=""></p>
<p>接下来我们需要为MultiLevelMenu，填充点真实的数据了，这部分才是我们真正的重点，所以打起精神吧少年！！。</p>
<p>看看我们每一级的table view需要显示什么数据，可以发现只要显示某个level的名称就够了，选中一个level就会显示所有下一级的名称，因此我们可以定义一个Level类，来代表每一个需要显示的Level节点。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Level</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> levelName = <span class="string">""</span></div><div class="line">    <span class="keyword">var</span> netLevelItems: [<span class="type">Level</span>]?</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以让具体的Model去继承Level类，在MultiLevelMenu的使用上只需要知道levelName和对应的下一级就够了，所以MultiLevelMenu能够把Level类或者它的子类作为自己的数据源。</p>
<p>为了践行面向协议编程的思想，这里不使用继承的方式实现MultiLevelMenu的数据源结构，而将Level类以协议的方式实现。在View这个group中新建一个swift文件，命名为<font color="#FF8C00"> LeveItemProtocol.swift</font>，在这个文件中，我们定义LeveItemProtocol。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"></div><div class="line"><span class="meta">@objc</span> <span class="class"><span class="keyword">protocol</span> <span class="title">LeveItemProtocol</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> levelName: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">    <span class="keyword">var</span> nextLevelItems: [<span class="type">LeveItemProtocol</span>]? &#123; <span class="keyword">get</span> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LeveItemProtocol定义了两个属性，当前级别的名称和下一级别，如果当前级别是最后一级，那么下一级就是nil，所以下一级是optional类型的。</p>
<p>接下来我们将定义一个Model，用来表示城市信息。打开Resources这个group中的china-city-info.json文件，可以看到大量的json格式的城市信息数据，这里会使用到Unbox第三方库将JSON数据转为模型。</p>
<p>在Model这个group中新建一个swift文件，命名为<font color="#FF8C00">CityModel.swift</font>，将文件内容替换为下面的代码段。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"><span class="keyword">import</span> Unbox</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CityModel</span>: <span class="title">NSObject</span>, <span class="title">Unboxable</span>, <span class="title">LeveItemProtocol</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">    <span class="keyword">let</span> subCitys: [<span class="type">CityModel</span>]?</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> levelName: <span class="type">String</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.name</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> nextLevelItems: [<span class="type">LeveItemProtocol</span>]? &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.subCitys</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>(unboxer: <span class="type">Unboxer</span>) <span class="keyword">throws</span> &#123;</div><div class="line">        name = <span class="keyword">try</span> unboxer.unbox(key: <span class="string">"name"</span>)</div><div class="line">        subCitys = unboxer.unbox(key: <span class="string">"sub"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单的说明一下这个model，这里继承NSObject的原因是，LeveItemProtocol继承了NSObjectProtocol，而NSObject对NSObjectProtocol提供了默认实现，继承了NSObject也就满足了NSObjectProtocol的要求；Unboxable协议用来json转model，LeveItemProtocol可以让CityModel做为MultiLevelMenu的数据源。对于LeveItemProtocol的实现，我们这里是返回当前城市名称和下一级城市。实际中可能每个项目的model会和这里的有很大差别，可以根据自己的需求进行调整。</p>
<p>在ViewModel这个group中，创建一个CityViewModel.swift文件，我们将在这里把json数据转成我们可以使用的model，在这个文件中，添加以下代码。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"><span class="keyword">import</span> Unbox</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CityViewModel</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> cityArray: [<span class="type">CityModel</span>]? = <span class="keyword">self</span>.convertJSONDataToCityModel()</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">convertJSONDataToCityModel</span><span class="params">()</span></span> -&gt; [<span class="type">CityModel</span>]? &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> filePath = <span class="type">Bundle</span>.main.url(forResource: <span class="string">"china-city-info"</span>, withExtension: <span class="string">"json"</span>),</div><div class="line">            <span class="keyword">let</span> data = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: filePath) <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="keyword">let</span> cityArray: [<span class="type">CityModel</span>] = <span class="keyword">try</span> unbox(data: data)</div><div class="line">            <span class="keyword">return</span> cityArray</div><div class="line">        &#125; <span class="keyword">catch</span> &#123;</div><div class="line">            <span class="built_in">print</span>(error.localizedDescription)</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个对外公开的懒惰变量，通过这个变量获取到城市数组。实际工作由<font color="#FF8C00">func convertJSONDataToCityModel()</font>方法完成，在这里我们得到城市数据文件的路径，再用Data的初始化方法得到Data类型的数据，最后使用unbox的初始化方法，将json数据转化为城市数组。在路径错误，或者转换失败的情况下都会返回nil。</p>
<p>现在来看看我们是否正确的获取到了城市数据，切换到HomeViewController.swift文件，在<font color="#FF8C00">viewDidLoad()</font>方法的最后添加两行代码，并在最后的花括号中打个断点。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/code1.png" alt=""></p>
<p>运行到断点处，查看控制台，可以看到我们确实正确的获得了城市数据。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/code2.png" alt=""></p>
<p>删掉刚刚添加的两行代码和断点。接着我们切换到MultiLevelMenu.swift文件，我们需要为<font color="#FF8C00">MultiLevelMenuDataSource</font>声明一个新的数据方法<font color="#FF8C00">func firstLevelItems(of multiLevelMenu: MultiLevelMenu) -&gt; [LeveItemProtocol]?</font>，MultiLevelMenu将通过这个数据源方法获得真正展示的数据。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@objc</span> <span class="class"><span class="keyword">protocol</span> <span class="title">MultiLevelMenuDataSource</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</div><div class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">numberOfLevel</span><span class="params">(of multiLevelMenu: MultiLevelMenu)</span></span> -&gt; <span class="type">Int</span></div><div class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">firstLevelItems</span><span class="params">(of multiLevelMenu: MultiLevelMenu)</span></span> -&gt; [<span class="type">LeveItemProtocol</span>]?</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从方法名可以大概知道，这个方法让外界返回需要展示的第一级数据，为什么只要第一数据就够了呢？？因为这里的每一级数据都实现了LeveItemProtocol，所以我们能够通过nextLevelItems属性来得到下一级需要展示的数据。</p>
<p>在我们声明这个数据源方法的同时，Xcode也报错了，告诉我们HomeViewController没有遵守MultiLevelMenuDataSource协议。那我们就回到HomeViewController.swift文件，实现这个数据源方法。在HomeViewController的extension部分，添加这个数据源方法，在方法中，我们返回通过CityViewModel得到的城市数组数据。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">firstLevelItems</span><span class="params">(of multiLevelMenu: MultiLevelMenu)</span></span> -&gt; [<span class="type">LeveItemProtocol</span>]? &#123;</div><div class="line">    <span class="keyword">return</span> <span class="type">CityViewModel</span>().cityArray</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在回到MultiLevelMenu.swift文件，为MultiLevelMenu类添加以下两个属性。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">fileprivate</span> <span class="keyword">var</span> firstLevelItems: [<span class="type">LeveItemProtocol</span>]?</div><div class="line"><span class="keyword">fileprivate</span> <span class="built_in">lazy</span> <span class="keyword">var</span> selectedLevelItems = [<span class="type">LeveItemProtocol</span>?]()</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>firstLevelItems 记录第一级数据，通过第一级数据可以获取后续级别的数据，所及我们对第一级数据做一个引用</li>
<li>selectedLevelItems 记录选中的级别项，比如选中北京，海淀区，那么第一项是北京，第二项是海淀区，对应城市的第一级和第二级。</li>
</ul>
</blockquote>
<p>现在假设我们的MultiLevelMenu已经得到了第一级城市数据，我们还要展示第二级和第三级数据，因此我们需要对得到的第一级数据做一些处理。添加一个<font color="#FF8C00">func handleLevelData()</font>方法处理数据。在这里我们默认选中每一级的第一项，这就是for循环的作用。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">handleLevelData</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> firstLevelItems = firstLevelItems <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> level <span class="keyword">in</span> <span class="number">0</span>..&lt;numberOfLvel &#123;</div><div class="line">        <span class="keyword">if</span> selectedLevelItems.<span class="built_in">count</span> == <span class="number">0</span> &#123;</div><div class="line">            selectedLevelItems.append(firstLevelItems[<span class="number">0</span>])</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> <span class="keyword">let</span> nextLevelItems = selectedLevelItems[level - <span class="number">1</span>]?.nextLevelItems &#123;</div><div class="line">                selectedLevelItems.append(nextLevelItems[<span class="number">0</span>])</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                selectedLevelItems.append(<span class="literal">nil</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们需要对MultiLevelMenu类进行两处修改。首先让我们我们找到dataSource这个属性，修改它的属性观察者。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">weak</span> <span class="keyword">var</span> dataSource: <span class="type">MultiLevelMenuDataSource</span>? &#123;</div><div class="line">    <span class="keyword">didSet</span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> dataSource = dataSource <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        numberOfLvel = dataSource.numberOfLevel(of: <span class="keyword">self</span>)</div><div class="line">        firstLevelItems = dataSource.firstLevelItems(of: <span class="keyword">self</span>)</div><div class="line">        handleLevelData()</div><div class="line">        createMenuTableView()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>数据已经处理好，下一步我们修改tableview的数据源方法，将数据展示出来。修改如下。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</div><div class="line">    <span class="keyword">let</span> level = tableView.tag - <span class="number">100</span></div><div class="line">    <span class="keyword">if</span> level == <span class="number">0</span> &#123;</div><div class="line">        <span class="keyword">return</span> firstLevelItems?.<span class="built_in">count</span> ?? <span class="number">0</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> selectedLevelItems[level - <span class="number">1</span>]?.nextLevelItems?.<span class="built_in">count</span> ?? <span class="number">0</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> level = tableView.tag - <span class="number">100</span></div><div class="line">    </div><div class="line">    <span class="keyword">var</span> levelItem: <span class="type">LeveItemProtocol</span>?</div><div class="line">    <span class="keyword">if</span> level == <span class="number">0</span> &#123;</div><div class="line">        levelItem = firstLevelItems?[indexPath.row]</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        levelItem = selectedLevelItems[level - <span class="number">1</span>]?.nextLevelItems?[indexPath.row]</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="type">LevelItemCellReuseIdentifier</span>, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">LevelItemCell</span></div><div class="line">    </div><div class="line">    cell.levelNamelabel.text = levelItem?.levelName</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> cell</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们通过选中的级别来判断需要显示在tableview中多少行，在这里第一级别为省，我们直接返回第一级别的数目，对于第二级别(相对于省来说为市这个级别)，我们需要根据选中的第一级别来判断需要显示多少行，通过上一级的nextLevelItems属性，可以获得该级别的所有下一级项，我们返回所有下一级的数量。对于第三级别也用同样的方法得到需要显示的行数。得到下一级数量的逻辑是在else子句中。</p>
<p>有了行数之后，我们简单的对cell配置，我们根据当前显示的级别，获得需要显示的条目，这部分逻辑和获得行数的逻辑是几乎一样的，最后我们将级别的名称设置到cell上。</p>
<p>运行一遍看看效果。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/result1.png?imageView2/2/w/375" alt=""></p>
<p>可以看到我们正确的展示了城市数据，目前默认显示的是北京地区。只是现在还有一些问题，点击任何一个城市并没有更新对应的区域。现在我们就来解决这个问题。</p>
<p>滚动到文件的末尾，找到MultiLevelMenu的UITableViewDelegate这个extension部分，我们在这里实现<font color="#FF8C00">func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath)</font>代理方法，这个方法在tableview的某一行被选中时会被调用。添加以下代码段。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, didSelectRowAt indexPath: IndexPath)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> level = tableView.tag - <span class="number">100</span></div><div class="line">    updateNextLevelItems(selectedLevel: level, on: indexPath)</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">// 选中某一级别，需要更新对应的下一级别</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateNextLevelItems</span><span class="params">(selectedLevel: Int, on indexPath: IndexPath)</span></span> &#123;</div><div class="line">    <span class="comment">// 更新对应的下一级别</span></div><div class="line">    <span class="keyword">if</span> selectedLevel == <span class="number">0</span> &#123;</div><div class="line">        selectedLevelItems[<span class="number">0</span>] = firstLevelItems?[indexPath.row]</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        selectedLevelItems[selectedLevel] = selectedLevelItems[selectedLevel - <span class="number">1</span>]?.nextLevelItems?[indexPath.row]</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 后续选中的下一级别默认为第一项</span></div><div class="line">    <span class="keyword">for</span> level <span class="keyword">in</span> (selectedLevel+<span class="number">1</span>)..&lt;numberOfLvel &#123;</div><div class="line">        selectedLevelItems[level] = selectedLevelItems[level - <span class="number">1</span>]?.nextLevelItems?.first</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 刷新后续的tableview</span></div><div class="line">    <span class="keyword">for</span> level <span class="keyword">in</span> (selectedLevel+<span class="number">1</span>)..&lt;numberOfLvel &#123;</div><div class="line">        menuTableViews[level].reloadData()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里我们对选中级别做了更新，并且刷新对应的tableview。完成之后，再次运行程序，现在选中任何城市，都能够显示对应的城市信息。下图是选中广东省，珠海市的结果。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/result2.png?imageView2/2/w/375" alt=""></p>
<p>到这里为止，我们大部分的工作已经完成了。接下来我们还可以为MultiLevelMenu声明代理协议，通过这些代理协议，我们可以制定MultiLevelMenu的外观，以及告知外界我们选中的级别信息。找到<font color="#FF8C00">MultiLevelMenuDataSource</font>数据源协议声明的位置，在它的下方添加<font color="#FF8C00">MultiLevelMenuDelegate</font>代理协议的声明。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@objc</span> <span class="class"><span class="keyword">protocol</span> <span class="title">MultiLevelMenuDelegate</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@objc</span> <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">multiLevelMenu</span><span class="params">(multiLevelMenu: MultiLevelMenu, backgroundColorForLevel level: Int)</span></span> -&gt; <span class="type">UIColor</span></div><div class="line">    <span class="meta">@objc</span> <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">multiLevelMenu</span><span class="params">(multiLevelMenu: MultiLevelMenu, widthRatioForLevel level: Int)</span></span> -&gt; <span class="type">CGFloat</span></div><div class="line">    </div><div class="line">    <span class="meta">@objc</span> <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">multiLevelMenu</span><span class="params">(multiLevelMenu: MultiLevelMenu, didSelectedLastLevel selectedLevelItems: [LeveItemProtocol])</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个三个代理方法都是可选的，没有必要全部实现。从上之下每个方法的作用为：</p>
<blockquote>
<ul>
<li>从外界得到每一级别tableview的背景色</li>
<li>得到每一级别tableview的显示宽度比例</li>
<li>告知外界我们选中的级别</li>
</ul>
</blockquote>
<p>代理协议声明好之后，我们为MultiLevelMenu添加一个delegate变量，以及两个方法，分别用来改变tableview的背景色和显示宽度，这两个方法会在从外界获得背景色和显示宽度比例时被调用。</p>
<p>首先声明delegate变量</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">MultiLevelMenuDelegate</span>?</div></pre></td></tr></table></figure>
<p>再添加调整背景色和宽度的方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">changeTableViewBackgroudColor</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> level <span class="keyword">in</span> <span class="number">0</span>..&lt;numberOfLvel &#123;</div><div class="line">        <span class="keyword">let</span> backgroundColor = <span class="keyword">self</span>.delegate!.multiLevelMenu!(multiLevelMenu: <span class="keyword">self</span>, backgroundColorForLevel: level)</div><div class="line">        menuTableViews[level].backgroundColor = backgroundColor</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">remakeTableViewConstraints</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> level <span class="keyword">in</span> <span class="number">0</span>..&lt;numberOfLvel &#123;</div><div class="line">        <span class="keyword">let</span> widthRatio = <span class="keyword">self</span>.delegate!.multiLevelMenu!(multiLevelMenu: <span class="keyword">self</span>, widthRatioForLevel: level)</div><div class="line">        <span class="keyword">let</span> tableView = menuTableViews[level]</div><div class="line">        </div><div class="line">        tableView.snp.remakeConstraints(&#123; (make) <span class="keyword">in</span></div><div class="line">            make.top.bottom.equalToSuperview()</div><div class="line">            make.width.equalToSuperview().multipliedBy(widthRatio)</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> level == <span class="number">0</span> &#123;</div><div class="line">                make.leading.equalToSuperview()</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                make.leading.equalTo(<span class="keyword">self</span>.menuTableViews[level - <span class="number">1</span>].snp.trailing)</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这两个方法中，我们对delegate和可选方法进行了强制解包，这里本来应该做判空处理的，待会我们就可以知道为什么我们不需要在这里做判空处理。我们调整tableview的宽度，是通过设置宽度约束来实现的。</p>
<p>现在我们找到delegate变量，为它增加属性观察器.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">weak</span> <span class="keyword">var</span> delegate: <span class="type">MultiLevelMenuDelegate</span>? &#123;</div><div class="line">    <span class="keyword">didSet</span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> delegate = delegate <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> delegate.responds(to: #selector(<span class="type">MultiLevelMenuDelegate</span>.multiLevelMenu(multiLevelMenu:backgroundColorForLevel:))) &#123;</div><div class="line">            changeTableViewBackgroudColor()</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> delegate.responds(to: #selector(<span class="type">MultiLevelMenuDelegate</span>.multiLevelMenu(multiLevelMenu:backgroundColorForLevel:))) &#123;</div><div class="line">            remakeTableViewConstraints()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在delegate变量被设置之后，我们去改变tableview的背景色和显示宽度，我们在这里做了判空操作，这就是为什么我们不需要在前面两个方法中进行判空操作的原因。</p>
<p>切换到HomeViewController.swift文件，为HomeViewController添加MultiLevelMenuDelegate协议的实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">HomeViewController</span>: <span class="title">MultiLevelMenuDelegate</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">multiLevelMenu</span><span class="params">(multiLevelMenu: MultiLevelMenu, backgroundColorForLevel level: Int)</span></span> -&gt; <span class="type">UIColor</span> &#123;</div><div class="line">        <span class="keyword">if</span> level == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="type">UIColor</span>(white: <span class="number">0.92</span>, alpha: <span class="number">1.0</span>)</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> level == <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="type">UIColor</span>(white: <span class="number">0.94</span>, alpha: <span class="number">1.0</span>)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="type">UIColor</span>(white: <span class="number">0.96</span>, alpha: <span class="number">1.0</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">multiLevelMenu</span><span class="params">(multiLevelMenu: MultiLevelMenu, widthRatioForLevel level: Int)</span></span> -&gt; <span class="type">CGFloat</span> &#123;</div><div class="line">        <span class="keyword">if</span> level == <span class="number">0</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0.24</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> level == <span class="number">1</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0.38</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0.38</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的颜色和宽度比例可以根据需求调整。最后不要忘记设置MultiLevelMenu对象的delegate属性为self，找的multiLevelMenu的声明处，添加一行代码。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">multiLevelMenu.delegate = <span class="keyword">self</span></div></pre></td></tr></table></figure>
<p>最后运行我们的程序看看效果，看起来效果还是可以的。</p>
<p>接下来我们实现MultiLevelMenuDelegate协议的最后一个代理方法</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/result3.png?imageView2/2/w/375" alt=""></p>
<p>在我们刚刚的extension部分，实现最后一个代理方法，这里我们只是简单的打印级别名称。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">multiLevelMenu</span><span class="params">(multiLevelMenu: MultiLevelMenu, didSelectedLastLevel selectedLevelItems: [LeveItemProtocol])</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> levelItem <span class="keyword">in</span> selectedLevelItems &#123;</div><div class="line">        <span class="built_in">print</span>(levelItem.levelName)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>回到MultiLevelMenu.swift文件，是时候告知外界我们选中的级别信息了。修改tableview选中某一行的代理方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, didSelectRowAt indexPath: IndexPath)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> level = tableView.tag - <span class="number">100</span></div><div class="line">    updateNextLevelItems(selectedLevel: level, on: indexPath)</div><div class="line">    </div><div class="line">    <span class="comment">// 检查是否选中了最后一个级别，并对delegate和可选方法进行判空操作</span></div><div class="line">    <span class="keyword">if</span> (selectedLevelItems[level]?.nextLevelItems == <span class="literal">nil</span>)</div><div class="line">        &amp;&amp; (delegate != <span class="literal">nil</span>)</div><div class="line">        &amp;&amp; (delegate!.responds(to: #selector(<span class="type">MultiLevelMenuDelegate</span>.multiLevelMenu(multiLevelMenu:didSelectedLastLevel:)))) &#123;</div><div class="line">        delegate?.multiLevelMenu!(multiLevelMenu: <span class="keyword">self</span>, didSelectedLastLevel: selectedLevelItems.<span class="built_in">filter</span>&#123; $<span class="number">0</span> != <span class="literal">nil</span> &#125; <span class="keyword">as</span>! [<span class="type">LeveItemProtocol</span>])</div><div class="line">        dismiss(animated: <span class="literal">true</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里如果我们选中了最后一级就告诉外界我们选中的级别，并移除MultiLevelMenu。运行看看效果，这里我第一次选中了北京的朝阳区，第二次选中了广东佛山的三水区，都正确的在控制台打印出来了。</p>
<p><img src="http://op6guxky2.bkt.clouddn.com/result5.png" alt=""></p>
<p>我们还可以为MultiLevelMenu的展现和移除添加动画。首先我们找到<font color="#FF8C00">presnt(from view: UIView)</font>方法，在这个方法的最后，添加以下几行代码。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.改变约束让containerView的位置刚好在MultiLevelMenu控件的上方，并使约束立即生效</span></div><div class="line"><span class="keyword">self</span>.containerView.snp.remakeConstraints &#123; (make) <span class="keyword">in</span></div><div class="line">    make.leading.trailing.equalToSuperview()</div><div class="line">    make.height.equalTo(<span class="number">240</span>)</div><div class="line">    make.bottom.equalTo(<span class="keyword">self</span>.snp.top)</div><div class="line">&#125;</div><div class="line"><span class="keyword">self</span>.layoutIfNeeded()</div><div class="line"><span class="keyword">self</span>.alpha = <span class="number">0.0</span></div><div class="line">    </div><div class="line"><span class="comment">// 2.恢复containerView到原来的位置，使用动画让约束逐步生效</span></div><div class="line"><span class="keyword">self</span>.containerView.snp.remakeConstraints &#123; (make) <span class="keyword">in</span></div><div class="line">    make.leading.top.trailing.equalToSuperview()</div><div class="line">    make.height.equalTo(<span class="number">240</span>)</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="type">UIView</span>.animate(withDuration: <span class="type">CATransaction</span>.animationDuration()) &#123; </div><div class="line">    <span class="keyword">self</span>.alpha = <span class="number">1.0</span></div><div class="line">    <span class="keyword">self</span>.layoutIfNeeded()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们这里设置通过让containerView从上往下移动，以及改变MultiLevelMenu控件的透明度，产生一个动画。</p>
<p>我们还需要在MultiLevelMenu的类的初始化中添加一行代码，它让超出MultiLevelMenu控件的内容不可见。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.clipsToBounds = <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>现在修改<font color="#FF8C00">func dismiss(animated: Bool)</font>方法，并添加处理触摸事件的方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">dismiss</span><span class="params">(animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> animated &#123;</div><div class="line">        <span class="type">UIView</span>.animate(withDuration: <span class="type">CATransaction</span>.animationDuration(), animations: &#123; </div><div class="line">            <span class="keyword">self</span>.alpha = <span class="number">0.0</span></div><div class="line">        &#125;, completion: &#123; (<span class="number">_</span>) <span class="keyword">in</span></div><div class="line">            <span class="keyword">self</span>.removeFromSuperview()</div><div class="line">        &#125;)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">self</span>.removeFromSuperview()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    isShowed = <span class="literal">false</span></div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesBegan</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?)</span></span> &#123;</div><div class="line">    dismiss(animated: <span class="literal">true</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在移除MultiLevelMenu控件时，我们先将它的透明度变为0，完成之后再移除。运行看看效果吧，到这里我们的整个demo就算是完成了😃😃。</p>
<p>为了方便对照，可以在<a href="https://github.com/EgeTart/MlutiLevelMenuDemo">这里</a>下载demo。</p>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">Comments</h1> -->

  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
      
        <div class="nav-next">
          <a href="/2017/07/27/iOS-tips/" rel="next">Newer Posts <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->
<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">关于本站</h1>
        <div class="custom-widget-content">
          
          <p style="font-size:16pt;color:#333333;text-align:center">记录iOS开发知识, 也记录自己的一些随感随想....</p>
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Contact</h1>
        <div class="widget-text">
          
            
              <a href="https://github.com/xiazihan" class="icon icon-github" target="_blank">github</a>
            
              <a href="mailto:gaoyongxiao@meituan.com" class="icon icon-mail" target="_blank">mail</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Search</h1>
        <div class="widget-text">
          <form onSubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="search..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>ZiHan Blog &copy; 2017</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->
<script src="/js/app.js"></script>





</body>

</html>